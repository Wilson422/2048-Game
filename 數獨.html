<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>é€²éšç‰ˆæ•¸ç¨</title>
<style>
  :root {
    --bg-app: #f3f4f6;
    --bg-card: #ffffff;
    --primary: #2563eb;
    --primary-light: #eff6ff;
    --text-main: #1f2937;
    --text-sub: #6b7280;
    --border: #e5e7eb;
    --grid-line: #d1d5db;
    --grid-bold: #6b7280;
    --cell-bg: #ffffff;
    --cell-alt: #f8fafc;
    --cell-fixed: #111827;
    --cell-input: #1d4ed8;
    --cell-note: #64748b;
    --success: #16a34a;
    --error: #ef4444;
    --radius: 12px;
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    margin: 0;
    padding: 0;
    background-color: var(--bg-app);
    color: var(--text-main);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .app-container {
    width: 100%;
    max-width: 1000px;
    padding: 20px;
    display: grid;
    grid-template-columns: 1fr 340px;
    gap: 24px;
    align-items: start;
  }

  header {
    grid-column: 1 / -1;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--bg-card);
    padding: 12px 20px;
    border-radius: var(--radius);
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    border: 1px solid var(--border);
  }

  h1 {
    font-size: 1.25rem;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .badge {
    font-size: 0.7rem;
    background: var(--primary-light);
    color: var(--primary);
    padding: 2px 8px;
    border-radius: 99px;
    border: 1px solid #dbeafe;
  }

  /* --- é›£åº¦é¸æ“‡å™¨ (RWD scroll) --- */
  .difficulty-wrapper {
    max-width: 50%; /* æ‰‹æ©Ÿä¸Šé¿å…æ“ å£“æ¨™é¡Œ */
    overflow-x: auto; /* å…è¨±æ©«å‘æ²å‹• */
  }
  
  .difficulty-selector {
    display: inline-flex;
    background: var(--bg-app);
    padding: 4px;
    border-radius: 8px;
    white-space: nowrap;
  }

  .diff-btn {
    border: none;
    background: transparent;
    padding: 8px 12px;
    font-size: 0.9rem;
    color: var(--text-sub);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .diff-btn.active {
    background: #ffffff;
    color: var(--primary);
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    font-weight: 600;
  }
  /* åœ°ç„æ¨¡å¼ç‰¹åˆ¥è‰² */
  .diff-btn[data-mode="hell"].active {
    color: #dc2626; 
    background: #fef2f2;
  }
  /* è‡ªè£½æ¨¡å¼ç‰¹åˆ¥è‰² */
  .diff-btn[data-mode="custom"].active {
    color: #7c3aed;
    background: #f5f3ff;
  }

  /* --- æ£‹ç›¤å€ --- */
  .board-section {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .status-bar {
    display: flex;
    justify-content: space-between;
    font-size: 0.9rem;
    color: var(--text-sub);
    background: var(--bg-card);
    padding: 8px 16px;
    border-radius: 99px;
    border: 1px solid var(--border);
    box-shadow: 0 1px 2px rgba(0,0,0,0.03);
  }

  .status-item { display: flex; align-items: center; gap: 6px; }

  #sudoku-board {
    width: 100%;
    max-width: 550px;
    aspect-ratio: 1 / 1;
    margin: 0 auto;
    background: var(--bg-card);
    border: 2px solid var(--grid-bold);
    display: grid;
    grid-template-columns: repeat(9, 1fr);
    grid-template-rows: repeat(9, 1fr);
    border-radius: 4px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    position: relative;
  }

  .cell {
    border: 1px solid var(--grid-line);
    display: flex;
    align-items: center; justify-content: center;
    font-size: clamp(20px, 4vw, 32px);
    cursor: pointer;
    user-select: none;
    position: relative;
    background: var(--cell-bg);
    transition: background 0.1s;
    color: var(--cell-input);
    font-weight: 500;
  }

  .cell.fixed { font-weight: 700; color: var(--cell-fixed); }
  
  /* è‡ªè£½æ¨¡å¼ä¸‹çš„è¼¸å…¥ç‹€æ…‹ */
  .cell.setup-input { color: #7c3aed; font-weight: 600; }

  .cell.is-note {
    align-items: flex-start; justify-content: flex-start;
    padding: 2px;
    font-size: 10px !important;
    line-height: 1.1;
    color: var(--cell-note);
    letter-spacing: 1px;
    font-weight: normal;
    flex-wrap: wrap;
  }

  .cell:nth-child(3n) { border-right: 2px solid var(--grid-bold); }
  .cell:nth-child(9n) { border-right: none; } 
  .cell:nth-child(n+19):nth-child(-n+27),
  .cell:nth-child(n+46):nth-child(-n+54) { border-bottom: 2px solid var(--grid-bold); }
  .cell.block-alt { background-color: var(--cell-alt); }

  .cell.selected { background-color: #bfdbfe !important; }
  .cell.highlight { background-color: #eff6ff; }
  .cell.same-number { background-color: #dbeafe; font-weight: 700; }
  .cell.conflict { background-color: #fee2e2 !important; color: var(--error); }
  .cell.correct-anim { animation: pop 0.3s ease-out; }

  /* --- æ§åˆ¶å€ --- */
  .controls-section {
    background: var(--bg-card);
    border-radius: var(--radius);
    border: 1px solid var(--border);
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .tools-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
  .tool-btn {
    padding: 10px;
    border: 1px solid var(--border);
    background: #fff;
    border-radius: 8px;
    font-size: 0.9rem;
    display: flex; align-items: center; justify-content: center; gap: 6px;
    cursor: pointer;
  }
  .tool-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

  .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
  .num-btn {
    aspect-ratio: 1.5 / 1;
    border: 1px solid var(--border);
    background: #ffffff;
    border-radius: 8px;
    font-size: 1.25rem;
    color: var(--primary);
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
  }
  .num-btn:active { transform: scale(0.96); background: var(--primary-light); }

  .action-btn {
    width: 100%; padding: 12px; border-radius: 8px; border: none;
    cursor: pointer; font-size: 1rem; font-weight: 600;
    background: var(--primary); color: white; margin-top: auto;
  }
  /* è‡ªè£½æ¨¡å¼ä¸‹æŒ‰éˆ•é¡è‰²ä¸åŒ */
  .action-btn.custom-mode { background: #7c3aed; }
  .action-btn.custom-mode:hover { background: #6d28d9; }

  .hint-text { font-size: 0.8rem; color: var(--text-sub); text-align: center; margin-top: 8px; min-height: 1.2em; }

  @media (max-width: 850px) {
    .app-container { grid-template-columns: 1fr; padding: 10px; gap: 10px; }
    header { padding: 8px 12px; }
    h1 { font-size: 1.1rem; }
    .badge { display: none; }
    .difficulty-wrapper { max-width: 100%; margin-top: 4px; }
    .status-bar { background: transparent; border: none; box-shadow: none; padding: 0; }
    .controls-section { padding: 0; border: none; background: transparent; gap: 10px; }
    .numpad { grid-template-columns: repeat(5, 1fr); gap: 6px; }
    .num-btn { font-size: 1.2rem; aspect-ratio: 1 / 1; border-radius: 50%; border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    #btn-num-0 { color: var(--error); }
    .tools-grid { grid-template-columns: repeat(4, 1fr); }
    .tool-btn { flex-direction: column; font-size: 0.75rem; padding: 6px; }
    .shortcuts { display: none; }
  }

  @keyframes pop { 50% { transform: scale(1.2); } }
</style>
</head>
<body>

<div class="app-container">
  <header>
    <h1>æ•¸ç¨ <span class="badge">Pro</span></h1>
    <!-- é›£åº¦é¸æ“‡å™¨ -->
    <div class="difficulty-wrapper">
      <div class="difficulty-selector">
        <button class="diff-btn" data-mode="custom" onclick="setDifficulty('custom')">è‡ªè£½</button>
        <button class="diff-btn active" data-mode="easy" onclick="setDifficulty('easy')">ç°¡å–®</button>
        <button class="diff-btn" data-mode="medium" onclick="setDifficulty('medium')">æ™®é€š</button>
        <button class="diff-btn" data-mode="hard" onclick="setDifficulty('hard')">å›°é›£</button>
        <button class="diff-btn" data-mode="hell" onclick="setDifficulty('hell')">åœ°ç„</button>
      </div>
    </div>
  </header>

  <div class="board-section">
    <div class="status-bar">
      <div class="status-item">â³ <span id="timer">00:00</span></div>
      <div class="status-item">âŒ <span id="mistakes">0</span>/3</div>
    </div>
    <div id="sudoku-board"></div>
    <div class="hint-text" id="status-msg">è«‹é¸æ“‡é›£åº¦ä¸¦é–‹å§‹éŠæˆ²</div>
  </div>

  <div class="controls-section">
    <div class="tools-grid">
      <button class="tool-btn" id="btn-note" onclick="toggleNoteMode()">âœï¸ <span>è‰ç¨¿</span></button>
      <button class="tool-btn" onclick="giveHint()">ğŸ’¡ <span>æç¤º</span></button>
      <button class="tool-btn" onclick="checkBoard()">âœ… <span>æª¢æŸ¥</span></button>
      <button class="tool-btn" onclick="resetBoard()">ğŸ” <span>é‡ç½®</span></button>
    </div>

    <div class="numpad" id="numpad"></div>

    <button class="action-btn" id="btn-action" onclick="handleActionButton()">æ–°çš„ä¸€å±€</button>
    
    <div class="shortcuts" style="margin-top: 12px; font-size: 0.8rem; color: #9ca3af; text-align: center;">
      ğŸ’» éµç›¤ï¼šæ–¹å‘éµç§»å‹•ã€æ•¸å­—éµå¡«å…¥ã€N åˆ‡æ›è‰ç¨¿
    </div>
  </div>
</div>

<script>
/* --- æ ¸å¿ƒè®Šæ•¸ --- */
let board = [];
let notes = [];
let solution = [];
let initialBoard = [];
let timerInterval;
let seconds = 0;
let mistakes = 0;
let isNoteMode = false;
let selectedCellIndex = -1;
let currentDifficulty = 'easy';
let isCustomSetup = false; // æ˜¯å¦è™•æ–¼è‡ªè£½é¡Œç›®è¨­å®šæ¨¡å¼

window.onload = () => {
  initUI();
  newGame();
};

/* --- åˆå§‹åŒ– UI --- */
function initUI() {
  const boardEl = document.getElementById('sudoku-board');
  boardEl.innerHTML = '';
  for (let i = 0; i < 81; i++) {
    const cell = document.createElement('div');
    cell.classList.add('cell');
    // 3x3 èƒŒæ™¯
    const row = Math.floor(i / 9);
    const col = i % 9;
    const blockRow = Math.floor(row / 3);
    const blockCol = Math.floor(col / 3);
    if ((blockRow * 3 + blockCol) % 2 !== 0) cell.classList.add('block-alt');

    cell.dataset.index = i;
    cell.onclick = () => selectCell(i);
    boardEl.appendChild(cell);
  }

  const numpad = document.getElementById('numpad');
  numpad.innerHTML = '';
  for (let n = 1; n <= 9; n++) {
    const btn = document.createElement('button');
    btn.className = 'num-btn';
    btn.textContent = n;
    btn.onclick = () => inputNumber(n);
    numpad.appendChild(btn);
  }
  const clearBtn = document.createElement('button');
  clearBtn.className = 'num-btn';
  clearBtn.id = 'btn-num-0';
  clearBtn.textContent = 'âŒ«';
  clearBtn.onclick = () => inputNumber(0);
  numpad.appendChild(clearBtn);

  document.addEventListener('keydown', handleKeyboard);
}

/* --- é›£åº¦èˆ‡æ¨¡å¼åˆ‡æ› --- */
function setDifficulty(diff) {
  // UI æ›´æ–°
  document.querySelectorAll('.diff-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelector(`.diff-btn[data-mode="${diff}"]`).classList.add('active');
  
  if (diff === 'custom') {
    startCustomSetup();
  } else {
    currentDifficulty = diff;
    isCustomSetup = false;
    newGame();
  }
}

/* --- ä¸»è¦éŠæˆ²æµç¨‹ (æ­£å¸¸æ¨¡å¼) --- */
function newGame() {
  // é‡ç½®ç‹€æ…‹
  stopTimer();
  seconds = 0; mistakes = 0;
  document.getElementById('timer').textContent = "00:00";
  document.getElementById('mistakes').textContent = "0";
  
  // æ¢å¾©æŒ‰éˆ•æ¨£å¼
  const actionBtn = document.getElementById('btn-action');
  actionBtn.textContent = "æ–°çš„ä¸€å±€";
  actionBtn.classList.remove('custom-mode');

  updateStatus("æ­£åœ¨ç”Ÿæˆé¡Œç›®...");

  setTimeout(() => {
    const fullBoard = generateFullSolution();
    solution = [...fullBoard];
    
    // è¨­å®šæŒ–æ´æ•¸é‡
    let holes;
    if (currentDifficulty === 'easy') holes = 30;
    else if (currentDifficulty === 'medium') holes = 40;
    else if (currentDifficulty === 'hard') holes = 50;
    else if (currentDifficulty === 'hell') holes = 58; // åœ°ç„æ¨¡å¼
    
    // åœ°ç„æ¨¡å¼å˜—è©¦æ¬¡æ•¸æ›´å¤šï¼Œç¢ºä¿é¡Œç›®æ›´é›£
    const attempts = currentDifficulty === 'hell' ? 500 : 200;

    initialBoard = removeNumbers(fullBoard, holes, attempts);
    board = [...initialBoard];
    notes = Array(81).fill('');

    renderBoard();
    startTimer();
    updateStatus(currentDifficulty === 'hell' ? "ğŸ”¥ åœ°ç„æ¨¡å¼é–‹å§‹ï¼Œç¥ä½ å¥½é‹ï¼" : "éŠæˆ²é–‹å§‹ï¼");
  }, 50);
}

/* --- è‡ªè£½é¡Œç›®æ¨¡å¼ (Custom Mode) --- */
function startCustomSetup() {
  stopTimer();
  document.getElementById('timer').textContent = "--:--";
  document.getElementById('mistakes').textContent = "-";
  
  isCustomSetup = true;
  currentDifficulty = 'custom';
  
  // æ¸…ç©ºæ‰€æœ‰è³‡æ–™
  board = Array(81).fill(0);
  initialBoard = Array(81).fill(0);
  solution = [];
  notes = Array(81).fill('');
  
  // æ›´æ–° UI
  const actionBtn = document.getElementById('btn-action');
  actionBtn.textContent = "é–‹å§‹è§£é¡Œ"; // æŒ‰éˆ•è®Šæ›´åŠŸèƒ½
  actionBtn.classList.add('custom-mode');
  
  renderBoard();
  updateStatus("âœï¸ è‡ªè£½æ¨¡å¼ï¼šè«‹é»æ“Šæ ¼å­å¡«å…¥é¡Œç›®æ•¸å­—");
}

function confirmCustomGame() {
  // 1. é©—è­‰ï¼šè‡³å°‘è¦å¡« 17 å€‹æ•¸å­— (æ•¸ç¨å”¯ä¸€è§£çš„æœ€å°æ¢ä»¶ï¼Œé›–ç„¶ä¸å¼·åˆ¶ä½†å»ºè­°)
  const clues = board.filter(n => n !== 0).length;
  if (clues < 17) {
    alert("é¡Œç›®æ•¸å­—å¤ªå°‘å›‰ï¼å»ºè­°è‡³å°‘å¡«å…¥ 17 å€‹æ•¸å­—ä»¥ç¢ºä¿æœ‰è§£ã€‚");
    return;
  }

  // 2. æª¢æŸ¥æ˜¯å¦æœ‰è¡çª
  if (!isValidBoardState(board)) {
    alert("ç›®å‰çš„é¡Œç›®æœ‰æ•¸å­—è¡çªï¼ˆåŒè¡Œã€åŒåˆ—æˆ–åŒå€æœ‰é‡è¤‡ï¼‰ï¼Œè«‹å…ˆä¿®æ­£ã€‚");
    return;
  }

  // 3. å˜—è©¦è§£é¡Œ
  updateStatus("æ­£åœ¨æª¢æŸ¥é¡Œç›®...");
  setTimeout(() => {
    const solved = solve(deepCopy(board));
    if (!solved) {
      alert("å“å‘€ï¼Œé€™å€‹é¡Œç›®ä¼¼ä¹ç„¡è§£ï¼è«‹èª¿æ•´æ•¸å­—ã€‚");
      updateStatus("é¡Œç›®ç„¡è§£ï¼Œè«‹ä¿®æ­£");
    } else {
      // æˆåŠŸï¼é–å®šé¡Œç›®
      solution = solved; // ç³»çµ±è§£å‡ºçš„ç­”æ¡ˆ
      initialBoard = [...board]; // å°‡ç›®å‰è¼¸å…¥è¨­ç‚ºå›ºå®šé¡Œ
      isCustomSetup = false;
      
      // UI åˆ‡æ›å›éŠæˆ²ç‹€æ…‹
      const actionBtn = document.getElementById('btn-action');
      actionBtn.textContent = "æ–°çš„ä¸€å±€";
      actionBtn.classList.remove('custom-mode');
      
      // é‡ç½®è¨ˆæ™‚èˆ‡éŒ¯èª¤
      seconds = 0; mistakes = 0;
      document.getElementById('mistakes').textContent = "0";
      startTimer();
      renderBoard(); // é‡æ–°æ¸²æŸ“ï¼Œæ•¸å­—æœƒè®Šé»‘
      updateStatus("è‡ªè£½é¡Œç›®é–‹å§‹ï¼");
    }
  }, 50);
}

/* --- æŒ‰éˆ•è¡Œç‚ºåˆ†æµ --- */
function handleActionButton() {
  if (isCustomSetup) {
    confirmCustomGame();
  } else {
    // å¦‚æœåœ¨è‡ªè£½æ¨¡å¼çµæŸå¾Œçš„éŠæˆ²ä¸­æŒ‰æ–°å±€ï¼Œå›åˆ°è¨­å®šé‚„æ˜¯éš¨æ©Ÿï¼Ÿ
    // é‚è¼¯ï¼šå¦‚æœåœ¨ Custom é›£åº¦ä¸‹æŒ‰æ–°å±€ï¼Œå°±æ¸…ç©ºé‡ä¾†ï¼Œå›åˆ°è¨­å®šæ¨¡å¼
    if (currentDifficulty === 'custom') {
      startCustomSetup();
    } else {
      newGame();
    }
  }
}

/* --- æ¸²æŸ“èˆ‡äº’å‹• --- */
function renderBoard() {
  const cells = document.querySelectorAll('.cell');
  cells.forEach((cell, i) => {
    cell.classList.remove('fixed', 'selected', 'highlight', 'same-number', 'conflict', 'correct-anim', 'is-note', 'setup-input');
    cell.textContent = '';
    cell.style.color = '';

    const val = board[i];
    const noteVal = notes[i];

    if (isCustomSetup) {
      // è¨­å®šæ¨¡å¼ï¼šæ‰€æœ‰é0æ•¸å­—éƒ½æ˜¯ç´«è‰² (setup-input)
      if (val !== 0) {
        cell.textContent = val;
        cell.classList.add('setup-input');
        // æª¢æŸ¥å³æ™‚è¡çª
        if (!isSafe(board, Math.floor(i/9), i%9, val, true)) {
          cell.classList.add('conflict');
        }
      }
    } else {
      // éŠæˆ²æ¨¡å¼
      if (initialBoard[i] !== 0) {
        cell.classList.add('fixed');
        cell.textContent = initialBoard[i];
      } else if (val !== 0) {
        cell.textContent = val;
        if (solution.length > 0 && val !== solution[i]) {
          cell.classList.add('conflict');
        } else {
          cell.style.color = 'var(--cell-input)';
        }
      } else if (noteVal !== '') {
        cell.classList.add('is-note');
        cell.textContent = noteVal.split(',').join(' ');
      }
    }
  });
  if (selectedCellIndex !== -1) selectCell(selectedCellIndex);
}

function inputNumber(num) {
  if (selectedCellIndex === -1) return;
  
  // éŠæˆ²æ¨¡å¼ä¸‹ï¼Œå›ºå®šæ ¼ä¸èƒ½æ”¹
  if (!isCustomSetup && initialBoard[selectedCellIndex] !== 0) return;

  const cell = document.querySelectorAll('.cell')[selectedCellIndex];

  // æ¸…é™¤
  if (num === 0) {
    board[selectedCellIndex] = 0;
    notes[selectedCellIndex] = '';
    renderBoard();
    return;
  }

  // è‰ç¨¿æ¨¡å¼ (åƒ…åœ¨éè¨­å®šæ¨¡å¼ä¸‹æœ‰æ•ˆ)
  if (isNoteMode && !isCustomSetup) {
    if (board[selectedCellIndex] !== 0) board[selectedCellIndex] = 0;
    let currentNotes = notes[selectedCellIndex] ? notes[selectedCellIndex].split(',') : [];
    const sNum = num.toString();
    if (currentNotes.includes(sNum)) currentNotes = currentNotes.filter(n => n !== sNum);
    else currentNotes.push(sNum);
    currentNotes.sort();
    notes[selectedCellIndex] = currentNotes.join(',');
    renderBoard();
    return;
  }

  // ä¸€èˆ¬å¡«å¯« / è¨­å®šæ¨¡å¼å¡«å¯«
  notes[selectedCellIndex] = ''; // æ¸…è‰ç¨¿
  
  if (isCustomSetup) {
    // è¨­å®šæ¨¡å¼ï¼šç›´æ¥å¡«å…¥ï¼Œä¸æª¢æŸ¥å°éŒ¯ï¼ˆå› ç‚ºé‚„æ²’é–‹å§‹ï¼‰ï¼Œåªæª¢æŸ¥åŸºæœ¬è¦å‰‡è¡çª
    board[selectedCellIndex] = num;
    renderBoard();
  } else {
    // éŠæˆ²æ¨¡å¼ï¼šæª¢æŸ¥å°éŒ¯
    if (num !== solution[selectedCellIndex]) {
      mistakes++;
      document.getElementById('mistakes').textContent = mistakes;
      board[selectedCellIndex] = num; 
      renderBoard();
      updateStatus("æ•¸å­—ä¸å°å–”ï¼");
      if (mistakes >= 3) updateStatus("éŒ¯èª¤é” 3 æ¬¡ï¼Œå»ºè­°ä½¿ç”¨æç¤ºï¼");
    } else {
      board[selectedCellIndex] = num;
      renderBoard();
      document.querySelectorAll('.cell')[selectedCellIndex].classList.add('correct-anim');
      if (!board.includes(0)) {
        stopTimer();
        updateStatus("ğŸ‰ æ­å–œé€šé—œï¼");
        setTimeout(() => alert("æ­å–œï¼ç”¨æ™‚ï¼š" + document.getElementById('timer').textContent), 100);
      }
    }
  }
}

/* --- è¼”åŠ©é‚è¼¯ --- */
function selectCell(index) {
  selectedCellIndex = index;
  const cells = document.querySelectorAll('.cell');
  const selectedVal = board[index];

  cells.forEach((cell, i) => {
    cell.classList.remove('selected', 'highlight', 'same-number');
    if (i === index) cell.classList.add('selected');
    const r1 = Math.floor(index/9), c1 = index%9;
    const r2 = Math.floor(i/9), c2 = i%9;
    if (r1 === r2 || c1 === c2) cell.classList.add('highlight');
    if (selectedVal !== 0 && board[i] === selectedVal) cell.classList.add('same-number');
  });
}

function toggleNoteMode() {
  if (isCustomSetup) {
    updateStatus("è¨­å®šæ¨¡å¼ä¸‹ç„¡æ³•ä½¿ç”¨è‰ç¨¿");
    return;
  }
  isNoteMode = !isNoteMode;
  const btn = document.getElementById('btn-note');
  if (isNoteMode) {
    btn.classList.add('active');
    updateStatus("è‰ç¨¿æ¨¡å¼ ON");
  } else {
    btn.classList.remove('active');
    updateStatus("è‰ç¨¿æ¨¡å¼ OFF");
  }
}

function giveHint() {
  if (isCustomSetup) return;
  const available = [];
  board.forEach((val, i) => { if (val === 0 || val !== solution[i]) available.push(i); });
  if (available.length === 0) return;
  
  let idx = selectedCellIndex;
  if (idx === -1 || board[idx] === solution[idx]) idx = available[Math.floor(Math.random() * available.length)];
  
  board[idx] = solution[idx];
  notes[idx] = '';
  renderBoard();
  selectCell(idx);
}

function checkBoard() {
  if (isCustomSetup) {
    // è¨­å®šæ¨¡å¼ä¸‹çš„æª¢æŸ¥ï¼šåªæª¢æŸ¥è¡çª
    if (!isValidBoardState(board)) updateStatus("ç™¼ç¾æ•¸å­—è¡çªï¼");
    else updateStatus("ç›®å‰æ•¸å­—æ’åˆ—åˆæ³•");
    return;
  }
  let err = 0;
  board.forEach((v, i) => { if (v !== 0 && v !== solution[i]) err++; });
  renderBoard();
  updateStatus(err > 0 ? `ç™¼ç¾ ${err} å€‹éŒ¯èª¤` : "ç›®å‰å…¨å°ï¼");
}

function resetBoard() {
  if (!confirm("é‡ç½®æœ¬å±€ï¼Ÿ")) return;
  if (isCustomSetup) {
    startCustomSetup(); // é‡ç½®ç‚ºå…¨ç©º
  } else {
    board = [...initialBoard];
    notes = Array(81).fill('');
    mistakes = 0;
    document.getElementById('mistakes').textContent = 0;
    renderBoard();
  }
}

/* --- æ¼”ç®—æ³•æ ¸å¿ƒ --- */
function generateFullSolution() {
  const b = Array(81).fill(0);
  fillBoard(b);
  return b;
}
function fillBoard(b) {
  const empty = b.indexOf(0);
  if (empty === -1) return true;
  const nums = shuffle([1,2,3,4,5,6,7,8,9]);
  for (let n of nums) {
    if (isSafe(b, Math.floor(empty/9), empty%9, n)) {
      b[empty] = n;
      if (fillBoard(b)) return true;
      b[empty] = 0;
    }
  }
  return false;
}
function isSafe(b, r, c, n, ignoreSelf = false) {
  const idx = r*9+c;
  for (let i=0; i<9; i++) {
    // Check Row
    if (b[r*9+i] === n && (r*9+i) !== idx) return false;
    // Check Col
    if (b[i*9+c] === n && (i*9+c) !== idx) return false;
    // Check Block
    const br = Math.floor(r/3)*3, bc = Math.floor(c/3)*3;
    const bi = (br+Math.floor(i/3))*9 + (bc+i%3);
    if (b[bi] === n && bi !== idx) return false;
  }
  return true;
}

// æª¢æŸ¥æ•´å€‹ç›¤é¢æ˜¯å¦æœ‰è¡çª
function isValidBoardState(b) {
  for (let i = 0; i < 81; i++) {
    if (b[i] !== 0) {
      if (!isSafe(b, Math.floor(i/9), i%9, b[i], true)) return false;
    }
  }
  return true;
}

function removeNumbers(solvedBoard, count, attempts = 200) {
  let b = [...solvedBoard];
  let c = count;
  while (c > 0 && attempts > 0) {
    let idx = Math.floor(Math.random() * 81);
    attempts--;
    if (b[idx] !== 0) {
      let backup = b[idx];
      b[idx] = 0;
      let solutions = 0;
      solveCount(b, (cnt) => solutions = cnt);
      if (solutions !== 1) b[idx] = backup;
      else c--;
    }
  }
  return b;
}

function solve(b) {
  // å–®ç´”è§£é¡Œç”¨
  const empty = b.indexOf(0);
  if (empty === -1) return b;
  for (let n=1; n<=9; n++) {
    if (isSafe(b, Math.floor(empty/9), empty%9, n)) {
      b[empty] = n;
      let res = solve(b);
      if (res) return res;
      b[empty] = 0;
    }
  }
  return null;
}

function solveCount(b, cb, ref={c:0}) {
  const empty = b.indexOf(0);
  if (empty === -1) { ref.c++; return; }
  for (let n=1; n<=9; n++) {
    if (ref.c > 1) return; 
    if (isSafe(b, Math.floor(empty/9), empty%9, n)) {
      b[empty] = n;
      solveCount(b, cb, ref);
      b[empty] = 0;
    }
  }
  cb(ref.c);
}

function deepCopy(arr) { return JSON.parse(JSON.stringify(arr)); }
function shuffle(arr) { return arr.sort(()=>Math.random()-0.5); }

function startTimer() {
  stopTimer();
  timerInterval = setInterval(() => {
    seconds++;
    const m = Math.floor(seconds / 60).toString().padStart(2, '0');
    const s = (seconds % 60).toString().padStart(2, '0');
    document.getElementById('timer').textContent = `${m}:${s}`;
  }, 1000);
}
function stopTimer() { clearInterval(timerInterval); }

function updateStatus(msg) {
  const el = document.getElementById('status-msg');
  el.textContent = msg;
}
function handleKeyboard(e) {
  if (selectedCellIndex === -1) return;
  const k = e.key;
  if (k >= '1' && k <= '9') inputNumber(parseInt(k));
  if (k === '0' || k === 'Backspace' || k === 'Delete') inputNumber(0);
  if (k.toLowerCase() === 'n') toggleNoteMode();
  
  if (['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(k)) {
    e.preventDefault();
    let r = Math.floor(selectedCellIndex / 9);
    let c = selectedCellIndex % 9;
    if (k === 'ArrowUp') r = (r - 1 + 9) % 9;
    if (k === 'ArrowDown') r = (r + 1) % 9;
    if (k === 'ArrowLeft') c = (c - 1 + 9) % 9;
    if (k === 'ArrowRight') c = (c + 1) % 9;
    selectCell(r * 9 + c);
  }
}
</script>
</body>
</html>
