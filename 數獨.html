<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>é€²éšç‰ˆæ•¸ç¨</title>
<style>
  :root {
    --bg-app: #f3f4f6;
    --bg-card: #ffffff;
    --primary: #2563eb;
    --primary-light: #eff6ff;
    --text-main: #1f2937;
    --text-sub: #6b7280;
    --border: #e5e7eb;
    --grid-line: #d1d5db;
    --grid-bold: #6b7280;
    --cell-bg: #ffffff;
    --cell-alt: #f8fafc;
    --cell-fixed: #111827;
    --cell-input: #1d4ed8;
    --cell-note: #64748b;
    --success: #16a34a;
    --error: #ef4444;
    --radius: 12px;
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    margin: 0; padding: 0;
    background-color: var(--bg-app); color: var(--text-main);
    min-height: 100vh;
    display: flex; flex-direction: column; align-items: center;
  }

  .app-container {
    width: 100%; max-width: 1000px; padding: 20px;
    display: grid; grid-template-columns: 1fr 340px; gap: 24px;
    align-items: start;
  }

  header {
    grid-column: 1 / -1;
    display: flex; justify-content: space-between; align-items: center;
    background: var(--bg-card); padding: 12px 20px;
    border-radius: var(--radius); border: 1px solid var(--border);
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }
  h1 { font-size: 1.25rem; margin: 0; display: flex; align-items: center; gap: 8px; }
  .badge { font-size: 0.7rem; background: var(--primary-light); color: var(--primary); padding: 2px 8px; border-radius: 99px; border: 1px solid #dbeafe; }

  /* é›£åº¦æ²è»¸ */
  .difficulty-wrapper { max-width: 50%; overflow-x: auto; }
  .difficulty-selector { display: inline-flex; background: var(--bg-app); padding: 4px; border-radius: 8px; white-space: nowrap; }
  .diff-btn { border: none; background: transparent; padding: 8px 12px; font-size: 0.9rem; color: var(--text-sub); border-radius: 6px; cursor: pointer; transition: all 0.2s; }
  .diff-btn.active { background: #ffffff; color: var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); font-weight: 600; }
  .diff-btn[data-mode="hell"].active { color: #dc2626; background: #fef2f2; }
  .diff-btn[data-mode="custom"].active { color: #7c3aed; background: #f5f3ff; }

  /* æ£‹ç›¤å€ */
  .board-section { display: flex; flex-direction: column; gap: 12px; position: relative; }

  .status-bar {
    display: flex; justify-content: space-between; font-size: 0.9rem;
    color: var(--text-sub); background: var(--bg-card);
    padding: 8px 16px; border-radius: 99px; border: 1px solid var(--border);
    box-shadow: 0 1px 2px rgba(0,0,0,0.03);
  }
  .status-item { display: flex; align-items: center; gap: 6px; }

  /* æš«åœæŒ‰éˆ• */
  .pause-btn {
    background: none; border: none; cursor: pointer; font-size: 1.1rem;
    color: var(--text-sub); width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;
    border-radius: 50%; transition: background 0.2s;
  }
  .pause-btn:hover { background: #f3f4f6; color: var(--primary); }

  /* æ£‹ç›¤å®¹å™¨ */
  .board-wrapper { position: relative; width: 100%; max-width: 550px; margin: 0 auto; aspect-ratio: 1/1; }

  #sudoku-board {
    width: 100%; height: 100%;
    background: var(--bg-card); border: 2px solid var(--grid-bold);
    display: grid; grid-template-columns: repeat(9, 1fr); grid-template-rows: repeat(9, 1fr);
    border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  }

  /* æš«åœé®ç½© */
  .pause-overlay {
    position: absolute; inset: 0;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(5px);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    z-index: 10; border-radius: 4px;
    color: var(--text-main); font-size: 1.2rem; font-weight: 600;
    display: none; /* é è¨­éš±è— */
  }
  .pause-overlay.active { display: flex; }
  .resume-btn-large {
    margin-top: 16px; padding: 10px 24px; background: var(--primary); color: white;
    border: none; border-radius: 99px; font-size: 1rem; cursor: pointer;
    box-shadow: 0 4px 12px rgba(37,99,235,0.3);
  }

  .cell {
    border: 1px solid var(--grid-line);
    display: flex; align-items: center; justify-content: center;
    font-size: clamp(20px, 4vw, 32px);
    cursor: pointer; user-select: none; position: relative;
    background: var(--cell-bg); transition: background 0.1s;
    color: var(--cell-input); font-weight: 500;
  }
  .cell.fixed { font-weight: 700; color: var(--cell-fixed); }
  .cell.setup-input { color: #7c3aed; font-weight: 600; }
  .cell.is-note {
    align-items: flex-start; justify-content: flex-start; padding: 2px;
    font-size: 10px !important; line-height: 1.1; color: var(--cell-note);
    letter-spacing: 1px; font-weight: normal; flex-wrap: wrap;
  }
  .cell:nth-child(3n) { border-right: 2px solid var(--grid-bold); }
  .cell:nth-child(9n) { border-right: none; } 
  .cell:nth-child(n+19):nth-child(-n+27),
  .cell:nth-child(n+46):nth-child(-n+54) { border-bottom: 2px solid var(--grid-bold); }
  .cell.block-alt { background-color: var(--cell-alt); }
  .cell.selected { background-color: #bfdbfe !important; }
  .cell.highlight { background-color: #eff6ff; }
  .cell.same-number { background-color: #dbeafe; font-weight: 700; }
  .cell.conflict { background-color: #fee2e2 !important; color: var(--error); }
  .cell.correct-anim { animation: pop 0.3s ease-out; }

  /* æ§åˆ¶å€ */
  .controls-section {
    background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--border);
    padding: 16px; display: flex; flex-direction: column; gap: 16px;
  }
  /* æš«åœæ™‚é–å®šæ§åˆ¶å€ */
  .controls-section.disabled { opacity: 0.5; pointer-events: none; filter: grayscale(0.5); }

  .tools-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
  .tool-btn {
    padding: 10px; border: 1px solid var(--border); background: #fff;
    border-radius: 8px; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; gap: 6px;
    cursor: pointer;
  }
  .tool-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

  .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
  .num-btn {
    aspect-ratio: 1.5 / 1; border: 1px solid var(--border); background: #ffffff;
    border-radius: 8px; font-size: 1.25rem; color: var(--primary); cursor: pointer;
    display: flex; align-items: center; justify-content: center;
  }
  .num-btn:active { transform: scale(0.96); background: var(--primary-light); }

  .action-btn {
    width: 100%; padding: 12px; border-radius: 8px; border: none;
    cursor: pointer; font-size: 1rem; font-weight: 600;
    background: var(--primary); color: white; margin-top: auto;
  }
  .action-btn.custom-mode { background: #7c3aed; }

  .hint-text { font-size: 0.8rem; color: var(--text-sub); text-align: center; margin-top: 8px; min-height: 1.2em; }

  @media (max-width: 850px) {
    .app-container { grid-template-columns: 1fr; padding: 10px; gap: 10px; }
    header { padding: 8px 12px; }
    h1 { font-size: 1.1rem; }
    .badge { display: none; }
    .difficulty-wrapper { max-width: 100%; margin-top: 4px; }
    .status-bar { background: transparent; border: none; box-shadow: none; padding: 0; }
    .controls-section { padding: 0; border: none; background: transparent; gap: 10px; }
    .numpad { grid-template-columns: repeat(5, 1fr); gap: 6px; }
    .num-btn { font-size: 1.2rem; aspect-ratio: 1 / 1; border-radius: 50%; border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    #btn-num-0 { color: var(--error); }
    .tools-grid { grid-template-columns: repeat(4, 1fr); }
    .tool-btn { flex-direction: column; font-size: 0.75rem; padding: 6px; }
    .shortcuts { display: none; }
  }
  @keyframes pop { 50% { transform: scale(1.2); } }
</style>
</head>
<body>

<div class="app-container">
  <header>
    <h1>æ•¸ç¨ <span class="badge">Pro</span></h1>
    <div class="difficulty-wrapper">
      <div class="difficulty-selector">
        <button class="diff-btn" data-mode="custom" onclick="setDifficulty('custom')">è‡ªè£½</button>
        <button class="diff-btn active" data-mode="easy" onclick="setDifficulty('easy')">ç°¡å–®</button>
        <button class="diff-btn" data-mode="medium" onclick="setDifficulty('medium')">æ™®é€š</button>
        <button class="diff-btn" data-mode="hard" onclick="setDifficulty('hard')">å›°é›£</button>
        <button class="diff-btn" data-mode="hell" onclick="setDifficulty('hell')">åœ°ç„</button>
      </div>
    </div>
  </header>

  <div class="board-section">
    <div class="status-bar">
      <div class="status-item">
        <button class="pause-btn" id="btn-pause" title="æš«åœ" onclick="togglePause()">â¸</button>
        <span id="timer">00:00</span>
      </div>
      <div class="status-item">âŒ <span id="mistakes">0</span>/3</div>
    </div>
    
    <div class="board-wrapper">
      <div id="sudoku-board"></div>
      <div class="pause-overlay" id="pause-overlay">
        <div>éŠæˆ²æš«åœ</div>
        <button class="resume-btn-large" onclick="togglePause()">â–¶ ç¹¼çºŒéŠæˆ²</button>
      </div>
    </div>
    
    <div class="hint-text" id="status-msg">è«‹é¸æ“‡é›£åº¦ä¸¦é–‹å§‹éŠæˆ²</div>
  </div>

  <div class="controls-section" id="controls-area">
    <div class="tools-grid">
      <button class="tool-btn" id="btn-note" onclick="toggleNoteMode()">âœï¸ <span>è‰ç¨¿</span></button>
      <button class="tool-btn" onclick="giveHint()">ğŸ’¡ <span>æç¤º</span></button>
      <button class="tool-btn" onclick="checkBoard()">âœ… <span>æª¢æŸ¥</span></button>
      <button class="tool-btn" onclick="resetBoard()">ğŸ” <span>é‡ç½®</span></button>
    </div>

    <div class="numpad" id="numpad"></div>

    <button class="action-btn" id="btn-action" onclick="handleActionButton()">æ–°çš„ä¸€å±€</button>
    
    <div class="shortcuts" style="margin-top: 12px; font-size: 0.8rem; color: #9ca3af; text-align: center;">
      ğŸ’» éµç›¤ï¼šæ–¹å‘éµç§»å‹•ã€æ•¸å­—éµå¡«å…¥ã€N åˆ‡æ›è‰ç¨¿
    </div>
  </div>
</div>

<script>
/* --- æ ¸å¿ƒè®Šæ•¸ --- */
let board = Array(81).fill(0);
let initialBoard = Array(81).fill(0);
let notes = Array(81).fill('');
let solution = [];
let timerInterval = null;
let seconds = 0;
let mistakes = 0;
let isNoteMode = false;
let selectedCellIndex = -1;
let currentDifficulty = 'easy';
let isCustomSetup = false;
let isPaused = false;

window.onload = () => {
  initUI();
  newGame();
};

/* --- UI åˆå§‹åŒ– --- */
function initUI() {
  const boardEl = document.getElementById('sudoku-board');
  boardEl.innerHTML = '';
  for (let i = 0; i < 81; i++) {
    const cell = document.createElement('div');
    cell.classList.add('cell');
    // 3x3 å€å¡ŠèƒŒæ™¯äº¤éŒ¯
    const r = Math.floor(i/9), c = i%9;
    const br = Math.floor(r/3), bc = Math.floor(c/3);
    if ((br*3 + bc)%2 !== 0) cell.classList.add('block-alt');
    
    cell.dataset.index = i;
    cell.onclick = () => selectCell(i);
    boardEl.appendChild(cell);
  }

  const numpad = document.getElementById('numpad');
  numpad.innerHTML = '';
  for (let n = 1; n <= 9; n++) {
    const btn = document.createElement('button');
    btn.className = 'num-btn';
    btn.textContent = n;
    btn.onclick = () => inputNumber(n);
    numpad.appendChild(btn);
  }
  const clearBtn = document.createElement('button');
  clearBtn.className = 'num-btn';
  clearBtn.id = 'btn-num-0';
  clearBtn.textContent = 'âŒ«';
  clearBtn.onclick = () => inputNumber(0);
  numpad.appendChild(clearBtn);

  document.addEventListener('keydown', handleKeyboard);
  document.addEventListener("visibilitychange", () => {
    if (document.hidden && !isPaused && !isCustomSetup) {
      togglePause();
    }
  });
}

/* --- é›£åº¦åˆ‡æ› --- */
function setDifficulty(diff) {
  document.querySelectorAll('.diff-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelector(`.diff-btn[data-mode="${diff}"]`).classList.add('active');
  if (diff === 'custom') startCustomSetup();
  else {
    currentDifficulty = diff;
    newGame();
  }
}

/* --- éŠæˆ²é‚è¼¯ --- */
function newGame() {
  // é‡ç½®ç‹€æ…‹
  stopTimer();
  seconds = 0; 
  mistakes = 0;
  document.getElementById('timer').textContent = "00:00";
  document.getElementById('mistakes').textContent = "0";
  
  isCustomSetup = false;
  isPaused = false;
  
  document.getElementById('pause-overlay').classList.remove('active');
  document.getElementById('controls-area').classList.remove('disabled');
  document.getElementById('btn-pause').style.display = 'flex';
  document.getElementById('btn-action').textContent = "æ–°çš„ä¸€å±€";
  document.getElementById('btn-action').classList.remove('custom-mode');
  
  updateStatus("æ­£åœ¨ç”Ÿæˆé¡Œç›®...");

  // ä½¿ç”¨æ¥µçŸ­å»¶é²ç¢ºä¿ UI åˆ·æ–°ï¼Œä½†é‚è¼¯åŒæ­¥åŸ·è¡Œ
  setTimeout(() => {
    // 1. ç”Ÿæˆå®Œæ•´è§£
    const fullBoard = generateFullSolution();
    solution = [...fullBoard];
    
    // 2. æŒ–æ´ (æ ¹æ“šé›£åº¦)
    let holes = 30; // easy
    if (currentDifficulty === 'medium') holes = 40;
    else if (currentDifficulty === 'hard') holes = 50;
    else if (currentDifficulty === 'hell') holes = 58;
    
    // 3. åŸ·è¡ŒæŒ–æ´ (æœƒç¢ºä¿å”¯ä¸€è§£)
    initialBoard = removeNumbers(fullBoard, holes);
    board = [...initialBoard];
    notes = Array(81).fill('');

    renderBoard();
    startTimer(); // ** ç›´æ¥é–‹å§‹è¨ˆæ™‚ **
    updateStatus(currentDifficulty === 'hell' ? "ğŸ”¥ åœ°ç„æ¨¡å¼é–‹å§‹ï¼" : "éŠæˆ²é–‹å§‹ï¼");
  }, 10);
}

/* --- è¨ˆæ™‚å™¨èˆ‡æš«åœ --- */
function startTimer() {
  if (timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    seconds++;
    const m = Math.floor(seconds / 60).toString().padStart(2, '0');
    const s = (seconds % 60).toString().padStart(2, '0');
    document.getElementById('timer').textContent = `${m}:${s}`;
  }, 1000);
}

function stopTimer() {
  if (timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
  }
}

function togglePause() {
  if (isCustomSetup) return;
  
  isPaused = !isPaused;
  const overlay = document.getElementById('pause-overlay');
  const controls = document.getElementById('controls-area');
  const pauseBtn = document.getElementById('btn-pause');

  if (isPaused) {
    stopTimer();
    overlay.classList.add('active');
    controls.classList.add('disabled');
    pauseBtn.textContent = "â–¶";
    updateStatus("éŠæˆ²æš«åœ");
  } else {
    startTimer();
    overlay.classList.remove('active');
    controls.classList.remove('disabled');
    pauseBtn.textContent = "â¸";
    updateStatus("éŠæˆ²ç¹¼çºŒ");
  }
}

/* --- è‡ªè£½æ¨¡å¼ --- */
function startCustomSetup() {
  stopTimer();
  seconds = 0;
  mistakes = 0;
  document.getElementById('timer').textContent = "00:00";
  document.getElementById('mistakes').textContent = "0";

  isCustomSetup = true;
  currentDifficulty = 'custom';
  isPaused = false;
  
  board = Array(81).fill(0);
  initialBoard = Array(81).fill(0);
  solution = [];
  notes = Array(81).fill('');
  
  document.getElementById('btn-pause').style.display = 'none';
  document.getElementById('pause-overlay').classList.remove('active');
  document.getElementById('controls-area').classList.remove('disabled');
  
  const actionBtn = document.getElementById('btn-action');
  actionBtn.textContent = "é–‹å§‹è§£é¡Œ";
  actionBtn.classList.add('custom-mode');
  
  renderBoard();
  updateStatus("âœï¸ è‡ªè£½æ¨¡å¼ï¼šè«‹å¡«å…¥é¡Œç›®");
}

function confirmCustomGame() {
  const clues = board.filter(n => n !== 0).length;
  if (clues < 17) { alert("æ•¸å­—å¤ªå°‘å›‰ï¼å»ºè­°è‡³å°‘ 17 å€‹ã€‚"); return; }
  if (!isValidBoardState(board)) { alert("é¡Œç›®æœ‰è¡çªï¼Œè«‹ä¿®æ­£ã€‚"); return; }

  updateStatus("æª¢æŸ¥é¡Œç›®ä¸­...");
  setTimeout(() => {
    const solved = solve(deepCopy(board));
    if (!solved) {
      alert("æ­¤é¡Œç„¡è§£ï¼");
      updateStatus("é¡Œç›®ç„¡è§£");
    } else {
      solution = solved;
      initialBoard = [...board];
      isCustomSetup = false;
      
      const actionBtn = document.getElementById('btn-action');
      actionBtn.textContent = "æ–°çš„ä¸€å±€";
      actionBtn.classList.remove('custom-mode');
      document.getElementById('btn-pause').style.display = 'flex';
      
      startTimer(); // è‡ªè£½ç¢ºèªå¾Œç›´æ¥é–‹å§‹è¨ˆæ™‚
      renderBoard();
      updateStatus("è‡ªè£½é¡Œç›®é–‹å§‹ï¼");
    }
  }, 50);
}

function handleActionButton() {
  if (isCustomSetup) confirmCustomGame();
  else if (currentDifficulty === 'custom') startCustomSetup();
  else newGame();
}

/* --- æ¸²æŸ“èˆ‡äº’å‹• --- */
function renderBoard() {
  const cells = document.querySelectorAll('.cell');
  cells.forEach((cell, i) => {
    cell.classList.remove('fixed', 'selected', 'highlight', 'same-number', 'conflict', 'correct-anim', 'is-note', 'setup-input');
    cell.textContent = '';
    cell.style.color = '';

    const val = board[i];
    if (isCustomSetup) {
      if (val !== 0) {
        cell.textContent = val;
        cell.classList.add('setup-input');
        if (!isSafe(board, Math.floor(i/9), i%9, val, true)) cell.classList.add('conflict');
      }
    } else {
      if (initialBoard[i] !== 0) {
        cell.classList.add('fixed');
        cell.textContent = initialBoard[i];
      } else if (val !== 0) {
        cell.textContent = val;
        if (solution.length > 0 && val !== solution[i]) cell.classList.add('conflict');
        else cell.style.color = 'var(--cell-input)';
      } else if (notes[i]) {
        cell.classList.add('is-note');
        cell.textContent = notes[i].split(',').join(' ');
      }
    }
  });
  if (selectedCellIndex !== -1 && !isPaused) selectCell(selectedCellIndex);
}

function inputNumber(num) {
  if (isPaused || selectedCellIndex === -1) return;
  if (!isCustomSetup && initialBoard[selectedCellIndex] !== 0) return;

  if (num === 0) {
    board[selectedCellIndex] = 0;
    notes[selectedCellIndex] = '';
    renderBoard(); return;
  }

  if (isNoteMode && !isCustomSetup) {
    if (board[selectedCellIndex] !== 0) board[selectedCellIndex] = 0;
    let cur = notes[selectedCellIndex] ? notes[selectedCellIndex].split(',') : [];
    const s = num.toString();
    if (cur.includes(s)) cur = cur.filter(n => n !== s); else cur.push(s);
    cur.sort();
    notes[selectedCellIndex] = cur.join(',');
    renderBoard(); return;
  }

  notes[selectedCellIndex] = '';
  if (isCustomSetup) {
    board[selectedCellIndex] = num;
    renderBoard();
  } else {
    if (num !== solution[selectedCellIndex]) {
      mistakes++;
      document.getElementById('mistakes').textContent = mistakes;
      board[selectedCellIndex] = num;
      renderBoard();
      updateStatus("æ•¸å­—éŒ¯èª¤");
      if (mistakes >= 3) updateStatus("éŒ¯èª¤é” 3 æ¬¡ï¼Œå»ºè­°ä½¿ç”¨æç¤º");
    } else {
      board[selectedCellIndex] = num;
      renderBoard();
      document.querySelectorAll('.cell')[selectedCellIndex].classList.add('correct-anim');
      if (!board.includes(0)) {
        stopTimer();
        updateStatus("ğŸ‰ æ­å–œé€šé—œï¼");
        setTimeout(() => alert("æ­å–œï¼ç”¨æ™‚ï¼š" + document.getElementById('timer').textContent), 100);
      }
    }
  }
}

function selectCell(index) {
  if (isPaused) return;
  selectedCellIndex = index;
  const cells = document.querySelectorAll('.cell');
  const sv = board[index];
  cells.forEach((c, i) => {
    c.classList.remove('selected', 'highlight', 'same-number');
    if (i === index) c.classList.add('selected');
    const r1 = Math.floor(index/9), c1 = index%9;
    const r2 = Math.floor(i/9), c2 = i%9;
    if (r1===r2 || c1===c2) c.classList.add('highlight');
    if (sv!==0 && board[i]===sv) c.classList.add('same-number');
  });
}

function toggleNoteMode() {
  if (isCustomSetup || isPaused) return;
  isNoteMode = !isNoteMode;
  const btn = document.getElementById('btn-note');
  if (isNoteMode) { btn.classList.add('active'); updateStatus("è‰ç¨¿ ON"); }
  else { btn.classList.remove('active'); updateStatus("è‰ç¨¿ OFF"); }
}

function giveHint() {
  if (isCustomSetup || isPaused) return;
  
  const av = [];
  board.forEach((v, i) => { if (v === 0 || v !== solution[i]) av.push(i); });
  if (av.length === 0) return;
  
  let idx = selectedCellIndex;
  if (idx === -1 || board[idx] === solution[idx]) idx = av[Math.floor(Math.random()*av.length)];
  
  board[idx] = solution[idx];
  notes[idx] = '';
  renderBoard();
  selectCell(idx);
}

function checkBoard() {
  if (isPaused) return;
  if (isCustomSetup) { updateStatus(isValidBoardState(board) ? "æ’åˆ—åˆæ³•" : "æœ‰è¡çªï¼"); return; }
  let err = 0;
  board.forEach((v, i) => { if (v !== 0 && v !== solution[i]) err++; });
  renderBoard();
  updateStatus(err > 0 ? `ç™¼ç¾ ${err} å€‹éŒ¯èª¤` : "ç›®å‰å…¨å°");
}

function resetBoard() {
  if (isPaused) return;
  if (!confirm("é‡ç½®æœ¬å±€ï¼Ÿ")) return;
  if (isCustomSetup) startCustomSetup();
  else {
    stopTimer();
    seconds = 0; document.getElementById('timer').textContent = "00:00";
    mistakes = 0; document.getElementById('mistakes').textContent = "0";
    board = [...initialBoard];
    notes = Array(81).fill('');
    renderBoard();
    startTimer();
    updateStatus("å·²é‡ç½®éŠæˆ²");
  }
}

function updateStatus(msg) {
  document.getElementById('status-msg').textContent = msg;
}

/* --- æ¼”ç®—æ³• (Backtracking) --- */
function generateFullSolution() {
  const b = Array(81).fill(0);
  fillBoard(b);
  return b;
}

function fillBoard(b) {
  const e = b.indexOf(0);
  if (e === -1) return true;
  const nums = shuffle([1,2,3,4,5,6,7,8,9]);
  for (let n of nums) {
    if (isSafe(b, Math.floor(e/9), e%9, n)) {
      b[e] = n;
      if (fillBoard(b)) return true;
      b[e] = 0;
    }
  }
  return false;
}

function isSafe(b, r, c, n, ignoreSelf=false) {
  const idx = r*9 + c;
  for (let i = 0; i < 9; i++) {
    if (b[r*9 + i] === n && (r*9 + i) !== idx) return false;
    if (b[i*9 + c] === n && (i*9 + c) !== idx) return false;
    const bi = (Math.floor(r/3)*3 + Math.floor(i/3))*9 + (Math.floor(c/3)*3 + i%3);
    if (b[bi] === n && bi !== idx) return false;
  }
  return true;
}

function isValidBoardState(b) {
  for (let i = 0; i < 81; i++) {
    if (b[i] !== 0 && !isSafe(b, Math.floor(i/9), i%9, b[i], true)) return false;
  }
  return true;
}

function removeNumbers(solvedBoard, holes) {
  let b = [...solvedBoard];
  let attempts = holes * 6; // é™åˆ¶å˜—è©¦æ¬¡æ•¸ï¼Œé˜²æ­¢å¡æ­»
  let removedCount = 0;
  
  while (removedCount < holes && attempts > 0) {
    let idx = Math.floor(Math.random() * 81);
    attempts--;
    
    if (b[idx] !== 0) {
      let backup = b[idx];
      b[idx] = 0;
      
      // å”¯ä¸€è§£æª¢æŸ¥
      if (countSolutions(b) !== 1) {
        b[idx] = backup;
      } else {
        removedCount++;
      }
    }
  }
  return b;
}

function countSolutions(b) {
  let count = 0;
  function backtrack(board) {
    let idx = board.indexOf(0);
    if (idx === -1) { count++; return; }
    let r = Math.floor(idx/9);
    let c = idx%9;
    
    for (let n = 1; n <= 9; n++) {
      if (count > 1) return; 
      if (isSafe(board, r, c, n)) {
        board[idx] = n;
        backtrack(board);
        board[idx] = 0;
      }
    }
  }
  backtrack([...b]);
  return count;
}

function solve(b) {
  const e = b.indexOf(0);
  if (e === -1) return b;
  for (let n = 1; n <= 9; n++) {
    if (isSafe(b, Math.floor(e/9), e%9, n)) {
      b[e] = n;
      const r = solve(b);
      if (r) return r;
      b[e] = 0;
    }
  }
  return null;
}

function deepCopy(a) { return JSON.parse(JSON.stringify(a)); }
function shuffle(a) { return a.sort(() => Math.random() - 0.5); }

function handleKeyboard(e) {
  if (isPaused || selectedCellIndex === -1) return;
  const k = e.key;
  if (k >= '1' && k <= '9') inputNumber(parseInt(k));
  if (k === '0' || k === 'Backspace' || k === 'Delete') inputNumber(0);
  if (k.toLowerCase() === 'n') toggleNoteMode();
  
  if (['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(k)) {
    e.preventDefault();
    let r = Math.floor(selectedCellIndex/9), c = selectedCellIndex%9;
    if (k === 'ArrowUp') r = (r-1+9)%9;
    if (k === 'ArrowDown') r = (r+1)%9;
    if (k === 'ArrowLeft') c = (c-1+9)%9;
    if (k === 'ArrowRight') c = (c+1)%9;
    selectCell(r*9 + c);
  }
}
</script>
</body>
</html>
